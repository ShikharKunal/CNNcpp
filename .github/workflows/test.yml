name: Cross-Platform Build Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.10', '3.12']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    # Linux dependencies
    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++
    
    # macOS dependencies
    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake
    
    # Windows dependencies
    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
      shell: powershell
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build C++ extension
      run: python build.py
    
    - name: Test import
      run: python -c "from python.mydl import SimpleCNN, Tensor; print('Import successful on ${{ matrix.os }} with Python ${{ matrix.python-version }}')"
    
    - name: Test basic functionality
      run: |
        python -c "from python.mydl import SimpleCNN; model = SimpleCNN(10); print('Model creation successful'); print('Parameters:', model.count_parameters())"
    
    - name: Show build info
      run: |
        python -c "import platform; print('Platform:', platform.system(), platform.release()); print('Python:', platform.python_version())"